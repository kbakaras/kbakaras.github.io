---
layout: post
title:  "Настройка валидации DataSource в Wildfly"
date:   2019-07-09 12:30:00 +0300
tags: wildfly datasource
---

## Суть проблемы

В Wildfly имеется Datasource, обеспечивающий приложения подключениями к базе данных. С настройками по умолчанию не осуществляется восстановление этих подключений в случае временной недоступности сервера БД.

## Как воспроизвести

1. Состояние работоспособности. Запущен сервер базы данных и сервер приложений, на сервере приложений имеется приложение с полезным функционалом. Выполняем в приложении любую функцию, приводящую к обращению к БД, и убеждаемся, что она сработает.

2. Выключаем сервер БД. Снова выполняем в приложении функцию, выполняющую доступ к БД. Получаем ошибку, так как сервер БД не доступен. *Это важный шаг, если его не выполнить, не получить ошибку, соединение может и пережить временное отключение БД.*

3. Запускаем сервер БД. И опять выполняем обращение к БД из нашего приложения. Несмотря на то, что сервер БД снова работает, получаем ошибку при попытке соединения.

## Решение

Необходимо настроить для нашего DataSource валидацию соединений. Она бывает двух видов:

* **validate-on-match** — гарантирует, что наше приложение будет всегда получать из пула проверенное соединение. При таком варианте обещают, что на долю приложения останется минимальное количество ошибок соединения, а при восстановлении БД восстановление соединения будет максимально быстрым. Платой за это будет несколько большая нагрузка на сервер БД.
* **background-validation** — предлагает компромиссный вариант. Валидация будет выполняться в отдельном потоке с заданной периодичностью. В большинстве источников рекомендуют этот вариант в качестве основного.
  При использовании данного способа нужно обязательно настроить параметр `background-validation-millis` . У него нет значения по умолчанию, если значение не задано, оно равно 0, что означает отсутствие валидации. Про это не очень чётко написано в [документации Wildfly](<https://docs.wildfly.org/12/Admin_Guide.html#datasource-definitions>), зато подробно объяснено в документации к [JBoss Enterprise Application Platform](<https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html/configuration_guide/datasource_management#configure_database_connection_validation_settings>).

## Дополнительные материалы

1. [Документация к Wildfly](<https://docs.wildfly.org/17/Admin_Guide.html#datasource-definitions>).
2. [Документация к проекту IronJacamar](<http://www.ironjacamar.org/doc/userguide/1.2/en-US/html/ch05.html#deployingds_descriptor>) (этот проект отвечает за реализацию функционала DataSource в Wildfly).
3. [Документация к JBoss Enterprise Application Platform](<https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.2/html/configuration_guide/datasource_management#configure_database_connection_validation_settings>) (мне показалась более полной, чем документация к Wildfly, но нужно учитывать, что эти продукты не во всём идентичны).
